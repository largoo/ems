/*
 * 入库单
 */

App.BillIn = function() {
	return {
		// 初始化
		render : function(id) {
			this.createPage(id);
		},
		
		createPage : function(id){
			var isadmin = user.roleid > 0 ? true : false
			
			var currentFormValues = {};
			
			var panel = Ext.getCmp(id);
			panel.body.dom.innerHTML = "";
			var sm = new Ext.grid.CheckboxSelectionModel({singleSelect : true});
			var store = new Ext.data.Store({
						remoteSort : true,
						autoLoad : true,
						baseParams : {
							start : 0,
							limit : 20
						},
						proxy : new Ext.data.HttpProxy({ // 获取数据的方式
							method : 'POST',
							url : '/ems/bill/queryIn.do'
						}),
						reader : new Ext.data.JsonReader({ // 数据读取器
							totalProperty : 'results',
							// 记录总数
							root : 'rows' // Json中的列表数据根节点
						}, ['id', 'type','userid','code','count','createtime','remark','user','state','finishtime'])
					});
			var grid = new Ext.grid.GridPanel({
						tbar : [{
									text : "新增",
									iconCls : "x-btn-add",
									handler : add
								}, {
									text : isadmin ? '查看|审批' : '查看',
									iconCls : "x-btn-edit",
									handler : edit
								}, "-",  {
									xtype : "button",
									text : "查询",
									iconCls : "x-btn-search",
									onClick : function(){
										store.reload();
									}
								}],
						bbar : new Ext.PagingToolbar({
									store : store,
									pageSize : 20,
									displayInfo : true
								}),

						store : store,
						sm : sm,
						columns : [sm, {
									dataIndex : 'id',
									hidden : true
								}, {
									dataIndex : 'userid',
									hidden : true
								},{
									header : "单据编码",
									sortable : true,
									dataIndex : "code"
								},{
									header : "入库时间",
									sortable : true,
									dataIndex : "createtime",
									renderer : function(v){
										return new Date(v).format("Y-m-d H:i:s");
									}	
								},{
									header : "入库人",
									sortable : true,
									dataIndex : "username",
									renderer : function(v,c,r){
										if(r.data.user){
											return r.data.user.name;
										}
									}
								},{
									header : "入库总数",
									sortable : true,
									dataIndex : "count"
								},{
									header : "状态",
									sortable : true,
									dataIndex : "state",
									renderer : function(v){
										if(v == 0){
											return "<span style='color:black;font-weight:bold;'>入库中</span>"
										}else if (v == 1){
											return "<span style='color:green;font-weight:bold;'>已入库</span>"
										}else if(v ==2){
											return "<span style='color:red;font-weight:bold;'>已撤回</span>"
										}
									}
								}],

						border : false,
						viewConfig : {
							forceFit : true
						}
					});
			panel.add(grid);

			function add(){
				win.setTitle("入库单");
				Ext.apply(currentFormValues, {
							type : 1,
							remark : "",
							action : 'add'
						});
				win.show();
			};
			
			function edit(){
				if (sm.hasSelection()) {
					viewwin.setTitle("单据明细");
					var rec = sm.getSelected();
					Ext.apply(currentFormValues, {
								id : rec.data.id,
								count : rec.data.count,
								remark : rec.data.remark,
								name : rec.data.user.name,
								createtime : new Date(rec.data.createtime).format("Y-m-d H:i:s"),
								action : 'update'
							});
					viewwin.show();
				} else {
					Ext.Msg.alert("信息", "请选择要查看的单据！");
				}
			}
			
			function del(){
			if (sm.hasSelection()) {
				var recs = sm.getSelections();
				var names = "";
				var ids = [];
				for (var i = 0; i < recs.length; i++) {
					names += "编码:" + recs[i].data.sn + "<br />";
					if(i == recs.length - 1){
						ids += recs[i].data.id
					}else{
						ids += recs[i].data.id + ','
					}
				}
				Ext.Msg.confirm("确认", "确认删除以下物品？<br />" + names, function(btn) {
							if (btn == "yes") {
								return 
								Ext.Ajax.request({
									url : '/ems/good/delete.do',
									method : 'POST',
									params : {
										datas : ids
									},
									success : function(response) {
										var o = Ext.util.JSON.decode(response.responseText);
										if(o.success){
											Ext.msg.msg('操作成功', o.msg);
											win.hide();
											store.reload();
										}else{
											Ext.msg.msg('操作失败', o.msg);
										}
									},
									failure : function() {
										Ext.msg.msg('error', '请联系管理员');
									}
								});	
							}
						});
			} else {
				Ext.Msg.alert("信息", "请选择要删除的物品！");
			}
		}
			
		var addstore = new Ext.data.JsonStore({
				fields : ['id', 'sn','name','brand','model','spec','unit','unitid','ver','amount','count']
		});
		
		var viewstore = new Ext.data.Store({
						remoteSort : true,
						proxy : new Ext.data.HttpProxy({ // 获取数据的方式
							method : 'POST',
							url : '/ems/billDetail/queryDetail.do'
						}),
						reader : new Ext.data.JsonReader({ // 数据读取器
							totalProperty : 'results',
							// 记录总数
							root : 'rows' // Json中的列表数据根节点
						}, ['id', 'billid','goodid','good','count','sn','name','brand','model','spec','unitname','amount'])
					});
		var addsm = new Ext.grid.CheckboxSelectionModel();
		
		var addgrid = new Ext.grid.EditorGridPanel({
						tbar : [{
									text : "新增",
									iconCls : "x-btn-add",
									handler : add1
								}, "-", {
									text : "删除",
									iconCls : "x-btn-del",
									handler : del1
								}],
						store : addstore,
						sm : addsm,
						height : 600,
						clicksToEdit: 1,
						columns : [addsm, {
									dataIndex : 'id',
									hidden : true
								},{
									header : "编码",
									sortable : true,
									dataIndex : "sn"
								},{
									header : "名称",
									sortable : true,
									dataIndex : "name"
								},{
									header : "品牌",
									sortable : true,
									dataIndex : "brand"
								},{
									header : "型号",
									sortable : true,
									dataIndex : "model"
								},{
									header : "规格",
									sortable : true,
									dataIndex : "spec"
								},{
									header : "单位",
									sortable : true,
									dataIndex : 'unitname',
									renderer : function(v,c,r){
										if(r.data.unit){
											return r.data.unit.name;
										}
									}
								},{
									header : "库存",
									sortable : true,
									dataIndex : "amount"
								},{
									header : "入库数量",
									sortable : true,
									dataIndex : "count",
						            editor: new Ext.form.NumberField({
						                allowBlank: false,
						                allowNegative: false
						            })
								},{
									hidden : true,
									dataIndex : "ver"
								},{
									hidden : true,
									dataIndex : "unitid"
								}],

						border : false,
						viewConfig : {
							forceFit : true
						}
					});
					
		var viewgrid = new Ext.grid.GridPanel({
						store : viewstore,
						height : 600,
						columns : [{
									dataIndex : 'id',
									hidden : true
								},{
									header : "编码",
									dataIndex : "sn",
									renderer : function(v,c,r){
										if(r){
											return r.data.good.sn
										}
									}
								},{
									header : "名称",
									dataIndex : "name",
									renderer : function(v,c,r){
										if(r){
											return r.data.good.name
										}
									}
								},{
									header : "品牌",
									sortable : true,
									dataIndex : "brand",
									renderer : function(v,c,r){
										if(r){
											return r.data.good.brand
										}
									}
								},{
									header : "型号",
									sortable : true,
									dataIndex : "model",
									renderer : function(v,c,r){
										if(r){
											return r.data.good.model
										}
									}
								},{
									header : "规格",
									sortable : true,
									dataIndex : "spec",
									renderer : function(v,c,r){
										if(r){
											return r.data.good.spec
										}
									}
								},{
									header : "单位",
									sortable : true,
									dataIndex : 'unitname',
									renderer : function(v,c,r){
										if(r){
											return r.data.good.unit.name;
										}
									}
								},{
									header : "库存",
									sortable : true,
									dataIndex : "amount",
									renderer : function(v,c,r){
										if(r){
											return r.data.good.amount
										}
									}
								},{
									header : "申领数量",
									sortable : true,
									dataIndex : "count",
									renderer : function(v,c,r){
										return v
									}
								}],

						border : false,
						viewConfig : {
							forceFit : true
						}
					});
					
		var form = new Ext.form.FormPanel({
						labelWidth : 60,
						buttonAlign : "center",
						bodyStyle : "padding:10px;",
						frame : true,
						defaults : {
							layout : "form"
						},
						items : [{
									xtype : "hidden",
									name : "action",
									value : ""
								}, {
									xtype : "hidden",
									name : "type"
								}, {
									xtype : "textfield",
									name : "count",
									hidden : true,
									fieldLabel : "总数",
									anchor : "98%"
								}, {
									xtype : "textarea",
									name : "remark",
									fieldLabel : "备注",
									anchor : "98%"
								},addgrid],
						buttons : [{
									text : "提交",
									handler : submit1
								}]
					});
					
		var viewform = new Ext.form.FormPanel({
						labelWidth : 60,
						buttonAlign : "center",
						bodyStyle : "padding:10px;",
						frame : true,
						defaults : {
							layout : "form"
						},
						items : [{
									xtype : "hidden",
									name : "id",
									value : ""
								}, {
									xtype : "hidden",
									name : "action",
									value : ""
								}, {
									xtype : "textfield",
									name : "name",
									fieldLabel : "申领人",
									anchor : "98%",
									disabled : true
								}, {
									xtype : "textfield",
									name : "createtime",
									fieldLabel : "申领时间",
									anchor : "98%",
									disabled : true	
								}, {
									xtype : "textfield",
									name : "count",
									fieldLabel : "总数",
									anchor : "98%",
									disabled : true
								}, {
									xtype : "textarea",
									name : "remark",
									fieldLabel : "备注",
									anchor : "98%",
									disabled : true
								},viewgrid],
						buttons : [{
									text : "通过",
									handler : submitpass,
									id : 'passinbillreq'
								},{
									text : "退回",
									handler : submitback,
									id : 'backinbillreq'
								}]
					});		
					
		var buttons = [{
			text : "通过",
			handler : submitpass
		},{
			text : "退回",
			handler : submitback
		}]
					
		var win = new Ext.Window({
						width : 800,
						height : 600,
						title : "",
						plain : true,
						resizable : false,
						frame : true,
						closeAction : "hide",
						border : false,
						modal : true,
						layout : "fit",
						items : [form],
						listeners : {
							render : function(fp) {
								form.form.waitMsgTarget = fp.getEl();
							},
							show : function() {
								form.form.setValues(currentFormValues);
								form.form.clearInvalid();
							}
						}
					});
					
		var viewwin = new Ext.Window({
						width : 800,
						height : 600,
						title : "",
						plain : true,
						resizable : false,
						frame : true,
						closeAction : "hide",
						border : false,
						modal : true,
						layout : "fit",
						items : [viewform],
						listeners : {
							render : function(fp) {
								viewform.form.waitMsgTarget = fp.getEl();
							},
							beforeShow : function(){
								if(isadmin == true){
									if(sm.getSelected().data.state != 0){
										Ext.getCmp('passinbillreq').setDisabled(true)
										Ext.getCmp('backinbillreq').setDisabled(true)
									}else{
										Ext.getCmp('passinbillreq').setDisabled(false)
										Ext.getCmp('backinbillreq').setDisabled(false)
									}
								}else{
									Ext.getCmp('passinbillreq').setDisabled(true)
									Ext.getCmp('backinbillreq').setDisabled(true)
								}
								
							},	
							show : function() {
								viewform.form.setValues(currentFormValues);
								viewform.form.clearInvalid();
								viewstore.load({
									params : {
										id : currentFormValues.id
									}
								})
							}
						}
					});	
					
		function submit1(){
				var fr = form.getForm(); // 获取BasicForm对象
				var da = addsm.getSelections();
				var list = [];
				var billDetail;
				var count = 0;
				for(var i=0;i<addstore.getCount();i++){
					var r = addstore.getAt(i);
					if(r.data.count == null || r.data.count == '' || r.data.count == 0){
						Ext.msg.msg('错误','编码为' + r.data.sn + '的物品入库数量没有填写');
						return
					}
					billDetail = new Object();
					billDetail.goodid = r.data.id
					billDetail.count = r.data.count
					list.push(billDetail)
					count += r.data.count;
				}
				fr.setValues({count : count});
				if (fr.isValid()) {
					var l = fr.getValues();
					Ext.MessageBox.wait('操作中...', '请稍候');
					Ext.Ajax.request({
						url : '/ems/bill/'+l.action + '.do',
						method : 'POST',
						params : {
							datas : Ext.encode(l),
							list : Ext.encode(list)
						},
						success : function(response) {
							var o = Ext.util.JSON.decode(response.responseText);
							if(o.success){
								Ext.msg.msg('操作成功', o.msg);
								Ext.MessageBox.hide();
								win.hide();
								addstore.removeAll();
								store.reload();
							}else{
								Ext.msg.msg('操作失败', o.msg);
								Ext.MessageBox.hide();
							}
						},
						failure : function() {
							Ext.msg.msg('error', '请联系管理员');
							Ext.MessageBox.hide();
						}
					});	
				}
			}	
			
			function submitpass(){
				
				var fr = viewform.form; // 获取BasicForm对象
				if (fr.isValid()) {
					var l = fr.getValues();
					Ext.MessageBox.wait('操作中...', '请稍候');
					Ext.Ajax.request({
						url : '/ems/bill/updateAmountPlus.do',
						method : 'POST',
						params : {
							id : l.id,
							type : 1
						},
						success : function(response) {
							var o = Ext.util.JSON.decode(response.responseText);
							if(o.success){
								Ext.MessageBox.hide();
								Ext.msg.msg('操作成功', o.msg);
								viewwin.hide();
								store.reload();
							}else{
								Ext.MessageBox.hide();
								Ext.msg.msg('操作失败', o.msg);
								
							}
						},
						failure : function() {
							Ext.MessageBox.hide();
							Ext.msg.msg('error', '请联系管理员');
						}
					});	
					
				}
			
			}
			
			function submitback(){
				var fr = viewform.form; // 获取BasicForm对象
				if (fr.isValid()) {
					var l = fr.getValues();
					Ext.MessageBox.wait('操作中...', '请稍候');
					Ext.Ajax.request({
						url : '/ems/bill/updateAmountPlus.do',
						method : 'POST',
						params : {
							id : l.id,
							type : 2
						},
						success : function(response) {
							var o = Ext.util.JSON.decode(response.responseText);
							if(o.success){
								Ext.MessageBox.hide();
								Ext.msg.msg('操作成功', o.msg);
								viewwin.hide();
								store.reload();
							}else{
								Ext.MessageBox.hide();
								Ext.msg.msg('操作失败', o.msg);
								
							}
						},
						failure : function() {
							Ext.MessageBox.hide();
							Ext.msg.msg('error', '请联系管理员');
						}
					});	
					
				}
			
			}
					
			function del1(){
				addstore.remove(addsm.getSelections());
			}		
					
			function add1(){
				var store = new Ext.data.Store({
					remoteSort : true,
					autoLoad : true,
					baseParams : {
						start : 0,
						limit : 20
					},
					proxy : new Ext.data.HttpProxy({ // 获取数据的方式
						method : 'POST',
						url : '/ems/good/query.do'
					}),
					reader : new Ext.data.JsonReader({ // 数据读取器
						totalProperty : 'results',
						// 记录总数
						root : 'rows' // Json中的列表数据根节点
					}, ['id', 'sn','name','brand','model','spec','unit','unitid','ver','amount'])
				});
				var sm = new Ext.grid.CheckboxSelectionModel();
				var grid = new Ext.grid.GridPanel({
						tbar : [{
									xtype : "button",
									text : "加入入库清单",
									iconCls : "x-btn-add",
									onClick : function(){
										var recs = sm.getSelections();
										addstore.add(recs)
										win.close()
									}
								},{text : '名称'},{
									xtype : "textfield",
									id : 'searcher_name_billwin',
									emptyText : "根据名称查询",
									enableKeyEvents:true,
									listeners : {
										keyup : function(){
											store.reload({
												params : {
													name : Ext.getCmp('searcher_name_billwin').getValue(),
													sn : Ext.getCmp('searcher_sn_billwin').getValue()
												}
											});
										}
									}
								}, {text : '编码'},{
									xtype : "textfield",
									id : 'searcher_sn_billwin',
									emptyText : "根据编码查询",
									enableKeyEvents:true,
									listeners : {
										keyup : function(){
											store.reload({
												params : {
													name : Ext.getCmp('searcher_name_billwin').getValue(),
													sn : Ext.getCmp('searcher_sn_billwin').getValue()
												}
											});
										}
									}
								}, {
									xtype : "button",
									text : "查询",
									iconCls : "x-btn-search",
									onClick : function(){
										store.reload({
											params : {
												name : Ext.getCmp('searcher_name_billwin').getValue(),
												sn : Ext.getCmp('searcher_sn_billwin').getValue()
											}
										});
									}
								}, {
									xtype : "button",
									text : "重置",
									scope : this,
									onClick : function(){
										Ext.getCmp('searcher_name_billwin').setValue('')
										Ext.getCmp('searcher_sn_billwin').setValue()
										store.reload({
											params : {
												name : null,
												sn : null
											}
										});
									}
								}],
						bbar : new Ext.PagingToolbar({
									store : store,
									pageSize : 20,
									displayInfo : true
								}),

						store : store,
						sm : sm,
						columns : [sm, {
									dataIndex : 'id',
									hidden : true
								},{
									header : "编码",
									sortable : true,
									dataIndex : "sn"
								},{
									header : "名称",
									sortable : true,
									dataIndex : "name"
								},{
									header : "品牌",
									sortable : true,
									dataIndex : "brand"
								},{
									header : "型号",
									sortable : true,
									dataIndex : "model"
								},{
									header : "规格",
									sortable : true,
									dataIndex : "spec"
								},{
									header : "单位",
									sortable : true,
									dataIndex : 'unitname',
									renderer : function(v,c,r){
										if(r.data.unit){
											return r.data.unit.name;
										}
									}
								},{
									header : "库存",
									sortable : true,
									dataIndex : "amount"
								},{
									hidden : true,
									dataIndex : "ver"
								},{
									hidden : true,
									dataIndex : "unitid"
								}],

						border : false,
						viewConfig : {
							forceFit : true
						}
					});
					var win = new Ext.Window({
						width : 800,
						height : 600,
						title : "test",
						plain : true,
						resizable : false,
						frame : true,
						closeAction : "hide",
						border : false,
						modal : true,
						layout : "fit",
						items : [grid]
					});
					win.show()
			}
		}
	}
}();
